<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Barber shop Website Design</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/all.min.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&family=Poppins&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/cferdinandi/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>
   </head>    
<body>
<section id="banner-admin">
    <img src="images/Logo1.jpg" class="logo" alt="Hair Care Studio Logo">
</section>

<div id="sideNav">
    <nav>
    <ul>
        <li><a href="index.html">HOME</a></li>
        <li><a href="index.html#feature">FEATURES</a></li>
        <li><a href="index.html#service">SERVICES</a></li>
        <li><a href="index.html#news-blog">NEWS & EVENTS</a></li>
        <li><a href="booking-visit.html">BOOKING</a></li>
        <li><a href="raven.html">RAVEN</a></li>
        <li><a href="index.html#Testimonial">TESTIMONIALS</a></li>
        <li><a href="index.html#footer">MEET US</a></li>
        <li><a id="view-profile-link" href="#">VIEW PROFILE</a></li>
    </ul>
    </nav>
</div>
<div id="menuBtn">
    <img src="images/menu-1.png" id="menu" alt="">
</div>

<!--Features-->

<section id="admin-event-creation">
    <div class="title-text">
        <p>LIVINGROOM507MOC's ADMIN</p>
        <h1>Create a New Event</h1>
    </div>
    <div class="contact-form-container">
        <form id="createEventForm">
            <label for="eventName">Event Name</label>
            <input type="text" id="eventName" name="name" required>

            <label for="eventDescription">Event Description</label>
            <textarea id="eventDescription" name="description" rows="4"></textarea>

            <label for="eventDate">Event Date</label>
            <input type="datetime-local" id="eventDate" name="event_date" required>

            <label for="eventLocation">Event Location</label>
            <input type="text" id="eventLocation" name="location" required>

            <label for="totalTickets">Total Tickets</label>
            <input type="number" id="totalTickets" name="total_tickets" required>

            <label for="imageUrl">Image URL <small>(Optional, a default image will be used if left blank)</small></label>
            <input type="text" id="imageUrl" name="image_url">

            <button type="submit" class="btn-primary">Create Event</button>
            <p id="formStatus"></p>
        </form>
    </div>
</section>

<section id="admin-approval">
    <div class="title-text">
        <p>ADMIN</p>
        <h1>Approve Profile Updates</h1>
    </div>
    <div id="approvalCardContainer" class="card-container">
        <!-- Approval cards will be inserted here by JavaScript -->
    </div>
    <p id="approvalStatus"></p>
</section>

<section id="admin-membership-approval">
    <div class="title-text">
        <p>ADMIN</p>
        <h1>Approve Membership Requests</h1>
    </div>
    <div id="membershipApprovalCardContainer" class="card-container">
        <!-- Membership approval cards will be inserted here by JavaScript -->
    </div>
    <p id="membershipApprovalStatus"></p>
</section>

<section id="admin-recruitment-approval">
    <div class="title-text">
        <p>ADMIN</p>
        <h1>Approve Recruitment Applications</h1>
    </div>
    <div id="recruitmentApprovalCardContainer" class="card-container">
        <!-- Recruitment approval cards will be inserted here by JavaScript -->
    </div>
    <p id="recruitmentApprovalStatus"></p>
</section>

<section id="admin-credentials">
    <div class="title-text">
        <p>ADMIN</p>
        <h1>Update Credentials</h1>
    </div>
    <div class="contact-form-container">
        <form id="updateCredentialsForm">
            <label for="currentEmail">Current Admin Email</label>
            <input type="email" id="currentEmail" name="currentEmail" required>

            <label for="newEmail">New Admin Email (optional)</label>
            <input type="email" id="newEmail" name="newEmail">

            <label for="newPassword">New Password (optional)</label>
            <input type="password" id="newPassword" name="newPassword">

            <label for="confirmPassword">Confirm New Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword">

            <button type="submit" class="btn-primary">Update Credentials</button>
            <p id="credentialsStatus"></p>
        </form>
    </div>
</section>

<script>
    var menuBtn = document.getElementById("menuBtn")
    var sideNav = document.getElementById("sideNav")
    var menu = document.getElementById("menu")
    let currentAdminEmail = ''; // Variable to store the admin's email

    sideNav.style.right = "-250px";

    menuBtn.onclick = function(){
        if(sideNav.style.right == "-250px"){
            sideNav.style.right = "0";
            menu.src = "images/close.png"; 
        }
        else{
            sideNav.style.right = "-250px";
            menu.src = "images/menu.png";
        }
    }

    document.getElementById('createEventForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const form = event.target;
        const statusMessage = document.getElementById('formStatus');
        statusMessage.textContent = 'Creating event...';

        const formData = new FormData(form);
        const data = {
            name: formData.get('name'),
            description: formData.get('description'),
            event_date: formData.get('event_date'),
            location: formData.get('location'),
            total_tickets: parseInt(formData.get('total_tickets'), 10),
            image_url: formData.get('image_url')
        };

        try {
            const response = await fetch('/api/create-event', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (response.ok) {
                statusMessage.textContent = 'Event created successfully!';
                statusMessage.style.color = 'green';
                form.reset();
            } else {
                statusMessage.textContent = `Error: ${result.message || 'Failed to create event.'}`;
                statusMessage.style.color = 'red';
            }
        } catch (error) {
            console.error('Event creation error:', error);
            statusMessage.textContent = 'An unexpected error occurred.';
            statusMessage.style.color = 'red';
        }
    });

    // Script for profile approvals
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Admin page loaded.');
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        console.log('Email from URL:', email);
        if (email) {
            currentAdminEmail = email; // Store the admin's email
            const profileLink = document.getElementById('view-profile-link');
            if (profileLink) {
                profileLink.href = `profile.html?email=${email}`;
                console.log('Profile link HREF set to:', profileLink.href);
            }
        } else {
            console.error('No email found in URL. Admin actions will fail.');
        }
        fetchPendingRequests();
        fetchPendingMembershipRequests();
        fetchPendingRecruitmentApplications();
    });

    async function fetchPendingRequests() {
        const approvalCardContainer = document.getElementById('approvalCardContainer');
        const approvalStatus = document.getElementById('approvalStatus');
        approvalStatus.textContent = 'Loading profile update requests...';

        try {
            const response = await fetch('/api/admin/requests');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const requests = await response.json();

            if (requests.length === 0) {
                approvalStatus.textContent = 'No pending profile update requests.';
                return;
            }

            approvalCardContainer.innerHTML = ''; // Clear loading message
            requests.forEach(req => {
                const card = document.createElement('div');
                card.className = 'approval-card';

                const changes = JSON.parse(req.requested_changes);
                let changesHtml = '<ul class="changes-list">';
                for (const key in changes) {
                    changesHtml += `<li><strong>${key}:</strong> ${changes[key]}</li>`;
                }
                changesHtml += '</ul>';

                card.innerHTML = `
                    <h3>Request ID: ${req.id}</h3>
                    <p><strong>Client:</strong> ${req.client_name} (${req.client_email})</p>
                    <p><strong>Submitted:</strong> ${new Date(req.created_at).toLocaleString()}</p>
                    <h4>Requested Changes:</h4>
                    ${changesHtml}
                    <div>
                        <button class="btn-approve" data-request-id="${req.id}">Approve</button>
                        <button class="btn-reject" data-request-id="${req.id}">Reject</button>
                    </div>
                `;
                approvalCardContainer.appendChild(card);
            });

            approvalStatus.textContent = ''; // Clear status message
        } catch (error) {
            console.error('Error fetching profile update requests:', error);
            approvalStatus.textContent = 'Failed to load profile update requests.';
            approvalStatus.style.color = 'red';
        }
    }

    async function fetchPendingMembershipRequests() {
        const membershipApprovalCardContainer = document.getElementById('membershipApprovalCardContainer');
        const membershipApprovalStatus = document.getElementById('membershipApprovalStatus');
        membershipApprovalStatus.textContent = 'Loading membership requests...';

        try {
            const response = await fetch('/api/admin/membership-requests');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const requests = await response.json();

            if (requests.length === 0) {
                membershipApprovalStatus.textContent = 'No pending membership requests.';
                return;
            }

            membershipApprovalCardContainer.innerHTML = ''; // Clear loading message
            requests.forEach(req => {
                const card = document.createElement('div');
                card.className = 'approval-card';

                card.innerHTML = `
                    <h3>Request ID: ${req.id}</h3>
                    <p><strong>Name:</strong> ${req.name}</p>
                    <p><strong>Email:</strong> ${req.email}</p>
                    <p><strong>Message:</strong> ${req.message}</p>
                    <p><strong>Submitted:</strong> ${new Date(req.created_at).toLocaleString()}</p>
                    <div>
                        <button class="btn-approve-membership" data-request-id="${req.id}">Approve</button>
                        <button class="btn-reject-membership" data-request-id="${req.id}">Reject</button>
                    </div>
                `;
                membershipApprovalCardContainer.appendChild(card);
            });

            membershipApprovalStatus.textContent = ''; // Clear status message
        } catch (error) {
            console.error('Error fetching membership requests:', error);
            membershipApprovalStatus.textContent = 'Failed to load membership requests.';
            membershipApprovalStatus.style.color = 'red';
        }
    }

    async function fetchPendingRecruitmentApplications() {
        const recruitmentApprovalCardContainer = document.getElementById('recruitmentApprovalCardContainer');
        const recruitmentApprovalStatus = document.getElementById('recruitmentApprovalStatus');
        recruitmentApprovalStatus.textContent = 'Loading recruitment applications...';

        try {
            const response = await fetch('/api/admin/recruitment-applications');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const applications = await response.json();

            if (applications.length === 0) {
                recruitmentApprovalStatus.textContent = 'No pending recruitment applications.';
                return;
            }

            recruitmentApprovalCardContainer.innerHTML = ''; // Clear loading message
            applications.forEach(app => {
                const card = document.createElement('div');
                card.className = 'approval-card';

                card.innerHTML = `
                    <h3>Application ID: ${app.id}</h3>
                    <p><strong>Name:</strong> ${app.name}</p>
                    <p><strong>Email:</strong> ${app.email}</p>
                    <p><strong>Resume:</strong> <a href="${app.resume_url}" target="_blank">View Resume</a></p>
                    <p><strong>Status:</strong> ${app.status}</p>
                    <p><strong>Submitted:</strong> ${new Date(app.created_at).toLocaleString()}</p>
                    <div>
                        ${app.status === 'PENDING' ? `
                        <button class="btn-approve-recruitment" data-application-id="${app.id}">Approve</button>
                        <button class="btn-reject-recruitment" data-application-id="${app.id}">Reject</button>
                        ` : ''}
                    </div>
                `;
                recruitmentApprovalCardContainer.appendChild(card);
            });

            recruitmentApprovalStatus.textContent = ''; // Clear status message
        } catch (error) {
            console.error('Error fetching recruitment applications:', error);
            recruitmentApprovalStatus.textContent = 'Failed to load recruitment applications.';
            recruitmentApprovalStatus.style.color = 'red';
        }
    }

    document.getElementById('approvalCardContainer').addEventListener('click', async function(event) {
        const target = event.target;
        const requestId = target.dataset.requestId;
        if (!requestId) return;

        if (target.classList.contains('btn-approve')) {
            const status = document.getElementById('approvalStatus');
            const adminUserId = currentAdminEmail; 

            target.disabled = true;
            status.textContent = 'Processing...';

            try {
                const response = await fetch('/api/admin/requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ requestId: parseInt(requestId, 10), adminUserId })
                });

                const result = await response.json();
                if (!response.ok) throw new Error((result.message || 'Failed to process request.') + (result.error ? `: ${result.error}` : ''));

                status.textContent = result.message;
                status.style.color = 'green';
                target.closest('.approval-card').remove(); 

            } catch (error) {
                console.error('Error processing profile update request:', error);
                status.textContent = `Error: ${error.message}`;
                status.style.color = 'red';
                target.disabled = false;
            }
        }
    });

    document.getElementById('membershipApprovalCardContainer').addEventListener('click', async function(event) {
        const target = event.target;
        const requestId = target.dataset.requestId;
        if (!requestId) return;

        const action = target.classList.contains('btn-approve-membership') ? 'APPROVE' : 
                       target.classList.contains('btn-reject-membership') ? 'REJECT' : null;

        if (!action) return;

        const status = document.getElementById('membershipApprovalStatus');
        const adminUserId = currentAdminEmail; 

        target.disabled = true;
        status.textContent = 'Processing...';

        try {
            const response = await fetch('/api/admin/membership-requests', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ requestId: parseInt(requestId, 10), action, adminUserId })
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Failed to process request.');

            status.textContent = result.message;
            status.style.color = 'green';
            target.closest('.approval-card').remove(); 

        } catch (error) {
            console.error('Error processing membership request:', error);
            status.textContent = `Error: ${error.message}`;
            status.style.color = 'red';
            target.disabled = false;
        }
    });

    document.getElementById('recruitmentApprovalCardContainer').addEventListener('click', async function(event) {
        const target = event.target;
        const applicationId = target.dataset.applicationId;
        if (!applicationId) return;

        const action = target.classList.contains('btn-approve-recruitment') ? 'APPROVE' :
                       target.classList.contains('btn-reject-recruitment') ? 'REJECT' : null;

        if (!action) return;

        const status = document.getElementById('recruitmentApprovalStatus');
        const adminUserId = currentAdminEmail; 

        target.disabled = true;
        status.textContent = 'Processing...';

        try {
            const response = await fetch('/api/admin/recruitment-applications', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ applicationId: parseInt(applicationId, 10), action, adminUserId })
            });

            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.error || result.message || 'Failed to process application.');
            }

            let successMsg = result.message;
            if (result.mailgunInfo) {
                successMsg += ` (Mailgun: ${JSON.stringify(result.mailgunInfo)})`;
            }
            status.textContent = successMsg;
            status.style.color = 'green';
            
            
            const buttonCell = target.parentElement;
            buttonCell.innerHTML = '';
            const statusCell = buttonCell.previousElementSibling;
            statusCell.textContent = action === 'APPROVE' ? 'APPROVED' : 'REJECTED';


        } catch (error) {
            console.error('Error processing recruitment application:', error);
            status.textContent = `Error: ${error.message}`;
            status.style.color = 'red';
            target.disabled = false;
        }
    });

    // Script for updating admin credentials
    document.getElementById('updateCredentialsForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const form = event.target;
        const statusMessage = document.getElementById('credentialsStatus');
        statusMessage.textContent = 'Updating...';

        const newPassword = form.newPassword.value;
        const confirmPassword = form.confirmPassword.value;
        const newEmail = form.newEmail.value;

        if (newPassword && newPassword !== confirmPassword) {
            statusMessage.textContent = 'Passwords do not match.';
            statusMessage.style.color = 'red';
            return;
        }

        const currentEmail = form.currentEmail.value;

        const data = {
            currentEmail: currentEmail,
            newEmail: newEmail || null,
            newPassword: newPassword || null
        };

        try {
            const response = await fetch('/api/admin/update-credentials', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (response.ok) {
                statusMessage.textContent = 'Credentials updated successfully! Please log in again with your new credentials.';
                statusMessage.style.color = 'green';
                form.reset();
            } else {
                throw new Error(result.message || 'Failed to update credentials.');
            }
        } catch (error) {
            console.error('Credential update error:', error);
            statusMessage.textContent = `Error: ${error.message}`;
            statusMessage.style.color = 'red';
        }
    });
</script>
</body>
</html>